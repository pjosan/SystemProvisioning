#version=RHEL8
ignoredisk --only-use=sda
autopart --type=lvm
# Partition clearing information
clearpart --all --initlabel
# Use text install
text
# Keyboard layouts
keyboard --vckeymap=us --xlayouts='us'
# System language
lang en_US.UTF-8

# Network information
network  --bootproto=static --device=enp0s3 --ipv6=auto --activate --ip=192.168.150.200 --netmask=255.255.255.0 --gateway=192.168.150.1 --nameserver=192.168.150.1
#network  --bootproto=dhcp --device=enp0s3 --ipv6=auto --activate
network  --hostname=todoapp.bcit.local

url --url=http://192.168.150.10/centos/
repo --name=epel --baseurl=https://dl.fedoraproject.org/pub/epel/$releasever/Everything/$basearch/ --install


# Root password
rootpw --iscrypted $6$XaCqfiiBHQs1wZbz$OSyXSBxC5vN81dp.EwK95AFkSkMINR23SGnmB.GxTTTE3Nj1qLCcvrp6WlBUFxqouaYxpZiR7wBvFMnRtEtqg1
# Run the Setup Agent on first boot
firstboot --disable
# Do not configure the X Window System
skipx
# System services
services --enabled="chronyd"
# System timezone
timezone America/Vancouver --isUtc

reboot

%packages
@minimal-environment
epel-release
%end
%addon com_redhat_kdump --enable --reserve-mb='auto'
%end

%anaconda
pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty
pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok
pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty
%end

%post
PXE_URL=http://192.168.150.10
ADMIN_HOME=/home/admin

rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-8
useradd -g users -G wheel admin
echo ${ADMIN_PASSWORD} | passwd admin
sed -r -i 's/^(%wheel\s+ALL=\(ALL\)\s+)(ALL)$/\1NOPASSWD: ALL/' /etc/sudoers


# Update DNF and install necessary services
dnf update -y
dnf install wget -y

# Setup SSH
mkdir $ADMIN_HOME/.ssh
# wget -O $ADMIN_HOME/acit_admin_id_rsa.pub http://192.168.150.10/acit_4640_key/acit_admin_id_rsa.pub
su - admin -c "wget http://192.168.150.10/acit_admin_id_rsa.pub"
mv $ADMIN_HOME/acit_admin_id_rsa.pub $ADMIN_HOME/.ssh/authorized_keys
chown admin $ADMIN_HOME/.ssh
chown admin $ADMIN_HOME/.ssh/authorized_keys
chmod 700 $ADMIN_HOME/.ssh
chmod 700 $ADMIN_HOME/.ssh/authorized_keys


# Setting up todoapp dependencies
mkdir $ADMIN_HOME/setup 
wget -O $ADMIN_HOME/setup/install_script.sh http://192.168.150.10/setup/install_script.sh
wget -O $ADMIN_HOME/setup/nginx.conf http://192.168.150.10/setup/nginx.conf
wget -O	$ADMIN_HOME/setup/mongodb-org-4.4.repo http://192.168.150.10/setup/mongodb-org-4.4.repo
wget -O $ADMIN_HOME/setup/todoapp.service http://192.168.150.10/setup/todoapp.service
chmod a+x $ADMIN_HOME/setup/install_script.sh

# Installing todoapp service

bash /home/admin/setup/install_script.sh


%end
